<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders â€“ Idea2Play</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/navbar.css">
</head>
<body>

<h2>My Orders</h2>

<div id="orderForm" style="display:none">
  <h3>Place Order</h3>
  <input id="name" placeholder="Full name">
  <input id="address" placeholder="Address">
  <input id="email" placeholder="Email">
  <button id="submitOrder">Submit Order</button>
</div>

<div id="orderList"></div>

<script type="module">
  import { auth, db, protectPage } from "./js/firebase.js";
  import {
    collection,
    addDoc,
    query,
    where,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  protectPage();

  const params = new URLSearchParams(location.search);
  if (params.get("new")) {
    orderForm.style.display = "block";
  }

  auth.onAuthStateChanged(async user => {
    if (!user) return;

    const q = query(
      collection(db, "orders"),
      where("userId", "==", user.uid)
    );

    const snap = await getDocs(q);
    snap.forEach(d => {
      const o = d.data();
      orderList.innerHTML += `
        <div class="order-card">
          <h4>${o.projectTitle}</h4>
          <p>Status: <strong>${o.status.replace("_", " ")}</strong></p>
        </div>
      `;
    });
  });

  submitOrder.onclick = async () => {
    const user = auth.currentUser;
    if (!user) return;

    await addDoc(collection(db, "orders"), {
      userId: user.uid,
      projectId: localStorage.getItem("orderProjectId"),
      projectTitle: localStorage.getItem("orderProjectTitle"),
      name: name.value,
      address: address.value,
      email: email.value,
      status: "pending",
      createdAt: serverTimestamp()
    });

    localStorage.clear();
    alert("Order placed!");
    location.href = "./orders.html";
  };
</script>

<script type="module" src="./js/navbar.js"></script>
</body>
</html>
