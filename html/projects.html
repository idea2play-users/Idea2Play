<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Projects â€“ Idea2Play</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/navbar.css">
</head>
<body>

<h2>My Projects</h2>
<div id="projectList"></div>

<script type="module">
  import { auth, db, protectPage } from "./js/firebase.js";
  import {
    collection,
    query,
    where,
    getDocs,
    doc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  protectPage();

  window.orderProject = (id, title) => {
    localStorage.setItem("orderProjectId", id);
    localStorage.setItem("orderProjectTitle", title);
    location.href = "./orders.html?new=true";
  };

  window.openProject = id => {
    location.href = `./studio.html?project=${id}`;
  };

  window.publishProject = async id => {
    const ref = doc(db, "projects", id);
    await updateDoc(ref, { published: true });
    alert("Project published!");
    location.reload();
  };

  auth.onAuthStateChanged(async user => {
    if (!user) return;

    const q = query(
      collection(db, "projects"),
      where("ownerId", "==", user.uid)
    );

    const snap = await getDocs(q);
    const list = document.getElementById("projectList");

    snap.forEach(d => {
      const p = d.data();
      list.innerHTML += `
        <div class="project-card">
          <h3>${p.title}</h3>

          <button onclick="openProject('${d.id}')">Edit</button>
          <button onclick="orderProject('${d.id}', '${p.title}')">Place Order</button>

          ${
            p.published
              ? `<span class="badge">Published</span>`
              : `<button onclick="publishProject('${d.id}')">Publish to Gallery</button>`
          }
        </div>
      `;
    });
  });
</script>

<script type="module" src="./js/navbar.js"></script>
</body>
</html>
